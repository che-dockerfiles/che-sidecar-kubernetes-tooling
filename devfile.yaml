apiVersion: 1.0.0

metadata:
  name: kubernetes-tooling-dev

projects:
  - name: che-sidecar-kubernetes-tooling
    source:
      location: 'https://github.com/che-dockerfiles/che-sidecar-kubernetes-tooling'
      # location: 'https://github.com/vitaliy-guliy/che-sidecar-kubernetes-tooling'
      type: git
      branch: master
      # branch: dev

  - name: vscode-kubernetes-tools
    source:
      location: 'https://github.com/Azure/vscode-kubernetes-tools'
      type: git
      branch: master

components:
  - type: cheEditor
    id: eclipse/che-theia/7.10.0
    memoryLimit: 1500M

  - type: dockerimage
    image: 'quay.io/eclipse/che-sidecar-kubernetes-tooling:1.1.0-31a8464'
    alias: buildah-dev
    mountSources: true
    memoryLimit: 3Gi
    env:
      - name: PLUGIN_REMOTE_ENDPOINT_EXECUTABLE
        value: 'tail -f /dev/null'

commands:

  - name: '1. Login to quay.io'
    actions:
      - workdir: /projects/che-sidecar-kubernetes-tooling
        type: exec
        command: |
          if [ ! -f "dev/login.sh" ]; then \
            mkdir -p dev; \
            curl -o dev/login.sh https://raw.githubusercontent.com/vitaliy-guliy/che-sidecar-kubernetes-tooling/dev/dev/login.sh; \
            chmod +x dev/login.sh; \
          fi; \
          pwd; \
          dev/login.sh
        component: buildah-dev

  - name: '2. Build the image'
    actions:
      - workdir: /projects/che-sidecar-kubernetes-tooling
        type: exec
        command: |
          if [ ! -f "dev/build.sh" ]; then \
            mkdir -p dev; \
            curl -o dev/build.sh https://raw.githubusercontent.com/vitaliy-guliy/che-sidecar-kubernetes-tooling/dev/dev/build.sh; \
            chmod +x dev/build.sh; \
          fi; \
          pwd; \
          dev/build.sh        
        component: buildah-dev

  - name: '3. Push to quay.io'
    actions:
      - workdir: /projects/che-sidecar-kubernetes-tooling
        type: exec
        command: |
          if [ ! -f "dev/push.sh" ]; then \
            mkdir -p dev; \
            curl -o dev/push.sh https://raw.githubusercontent.com/vitaliy-guliy/che-sidecar-kubernetes-tooling/dev/dev/push.sh; \
            chmod +x dev/push.sh; \
          fi; \
          pwd; \
          dev/push.sh
        component: buildah-dev

  - name: '4. Publish plugin.meta.yaml'
    actions:
      - workdir: /projects/che-sidecar-kubernetes-tooling
        type: exec
        command: |
          if [ -f "/tmp/username" ]; then \
            echo 'Downloading template for plugin meta.yaml...'; \
            curl -o /tmp/plugin-template.meta.yaml https://raw.githubusercontent.com/vitaliy-guliy/che-sidecar-kubernetes-tooling/dev/plugin-template.meta.yaml; \
            echo 'Generating plugin meta.yaml...'; \
            PLUGIN_IMAGE=`cat /tmp/plugin_image`; \
            PLUGIN_META_YAML=`node -pe "JSON.stringify(require('fs').readFileSync('/tmp/plugin-template.meta.yaml').toString().replace(/PLUGIN_IMAGE/g, '$PLUGIN_IMAGE'))"`; \
            read -p "GitHub login: " GITHUB_LOGIN; \
            read -s -p "GitHub password: " GITHUB_PASSWORD; \
            echo 'Pushing plugin meta.yaml to gist...'; \
            POST_DATA='{"public":true,"files":{"plugin.meta.yaml":{"content":'$PLUGIN_META_YAML'}}}'; \
            CURL_COMMAND=`echo "curl -X POST -d '"$POST_DATA"' -u "$GITHUB_LOGIN:$GITHUB_PASSWORD" https://api.github.com/gists > /tmp/plugin.gist.json"`; \
            eval $CURL_COMMAND; \
            PLUGIN_GIST_URL=`node -pe "JSON.parse(require('fs').readFileSync('/tmp/plugin.gist.json').toString()).files['plugin.meta.yaml'].raw_url"`; \
            echo 'Plugin gist URL' $PLUGIN_GIST_URL; \
            echo $PLUGIN_GIST_URL > /tmp/plugin.gist.url; \
            echo 'Done'; \
          else \
            echo 'The first, you need to login and build the image'; \
          fi
        component: buildah-dev

  - name: '5. Publish devfile.yaml'
    actions:
      - workdir: /projects/che-sidecar-kubernetes-tooling
        type: exec
        command: |
          if [ -f "/tmp/username" ]; then \
            echo 'Downloading template for devfile.yaml...'; \
            curl -o /tmp/devfile-template.yaml https://raw.githubusercontent.com/vitaliy-guliy/che-sidecar-kubernetes-tooling/dev/devfile-template.yaml; \
            echo 'Generating devfile.yaml...'; \
            PLUGIN_GIST_URL=`cat /tmp/plugin.gist.url`; \
            DEVFILE_YAML=`node -pe "JSON.stringify(require('fs').readFileSync('/tmp/devfile-template.yaml').toString().replace(/PLUGIN_GIST_URL/g, '$PLUGIN_GIST_URL'))"`; \
            read -p "GitHub login: " GITHUB_LOGIN; \
            read -s -p "GitHub password: " GITHUB_PASSWORD; \
            echo 'Pushing devfile.yaml to gist...'; \
            POST_DATA='{"public":true,"files":{"devfile.yaml":{"content":'$DEVFILE_YAML'}}}'; \
            CURL_COMMAND=`echo "curl -X POST -d '"$POST_DATA"' -u "$GITHUB_LOGIN:$GITHUB_PASSWORD" https://api.github.com/gists > /tmp/devfile.gist.json"`; \
            eval $CURL_COMMAND; \
            DEVFILE_RAW_URL=`node -pe "JSON.parse(require('fs').readFileSync('/tmp/devfile.gist.json').toString()).files['devfile.yaml'].raw_url"`; \
            echo 'Devfile.yaml URL' $DEVFILE_RAW_URL; \
            echo 'Done'; \
          else \
            echo 'The first, you need to login and build the image'; \
          fi
        component: buildah-dev

